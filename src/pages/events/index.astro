---
import type {
  EventsPageQuery,
  EventsPageQueryVariables,
  SiteLocale,
} from '@lib/types/datocms';
import { t } from '@lib/i18n';
import { datocmsRequest } from '@lib/datocms';
import { getToday } from '@lib/date';
import { setCacheControl } from '@lib/cache-control';
import query from './_eventsPage.query.graphql';

import Layout from '@layouts/Default.astro';

import { Button } from '@components/Button';
import { Heading } from '@components/Heading';
import EventList from '@blocks/EventList/EventList.astro';
import { Grid, Column } from '@components/Grid';
import { EventCard } from '@blocks/EventCard';
import PageHeader from '@blocks/PageHeader/PageHeader.astro';
import PartnerBanner from '@blocks/PartnerBanner/PartnerBanner.astro';

setCacheControl(Astro.response);

const { locale } = Astro.params;

const today = getToday();

const { page, highlightedEvents } = await datocmsRequest<
  EventsPageQuery,
  EventsPageQueryVariables
>({ query, variables: { locale: locale as SiteLocale, today } });

if (!page) {
  return new Response(null, { status: 404 });
}
---

<Layout pageUrls={[]} seoMetaTags={page._seoMetaTags}>
  <PageHeader title={page.header.title} subtitle={page.header.subtitle}>
    <Fragment slot="header">
      <Button
        as="a"
        href="../"
        className="back-button"
        level="tertiary"
        icon="arrow-left"
        iconPosition="left">{t('back_to_home')}</Button
      >
    </Fragment>
  </PageHeader>

  <Grid border>
    {
      highlightedEvents.map((event) => (
        <Column
          key={event.id}
          span={{
            mobile: 12,
            tablet: 6,
            // If there are less than 3 highlighted events, adjust span to half the grid.
            desktop: highlightedEvents.length < 3 ? 6 : 4,
          }}
        >
          <EventCard event={event} />
        </Column>
      ))
    }
  </Grid>

  <EventList
    queryKey="events"
    defaultPageSize={10}
    fixedFilters={{
      date: { gte: today },
    }}
  />

  <section class="past-events">
    <Heading className="past-events__heading" level={2} displayLevel={3}
    >{page.pastEventsTitle}</Heading
    >

    <EventList
      queryKey="past_events"
      defaultPageSize={3}
      showFilter={false}
      fixedFilters={{
        date: { lt: today },
      }}
    />
  </section>

  <PartnerBanner />
</Layout>

<style>
  .past-events__heading {
    border-block-start: 1px solid var(--color-black);
    padding-block: var(--spacing-48) 0;
    padding-inline: var(--spacing-16);
  }

  @media screen and (min-width: 890px) {
    .past-events__heading {
      padding-inline: var(--spacing-48);
    }

    .past-events__heading {
      border-block-start: 1px solid var(--color-black);
      padding-block: var(--spacing-48) 0;
      padding-inline: var(--spacing-16);
    }

    @media screen and (min-width: 890px) {
      .past-events__heading {
        padding-inline: var(--spacing-48);
      }
    }
  }
</style>
